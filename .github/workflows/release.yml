name: release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  id-token: write

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.x'

      - name: Run tests
        run: go test ./... -v

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Install Syft (for SBOM generation)
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh \
            | sh -s -- -b /usr/local/bin
          syft version

      - name: GoReleaser
        uses: goreleaser/goreleaser-action@v6.4.0
        with:
          distribution: goreleaser-pro
          version: latest
          args: release --clean --config .goreleaser.yaml --skip=sign --skip=notarize
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GORELEASER_KEY: ${{ secrets.GORELEASER_KEY }}
          GH_PAT: ${{ secrets.GH_PAT }}
          TNR_S3_BUCKET: ${{ secrets.TNR_S3_BUCKET }}
          AWS_REGION: ${{ secrets.AWS_REGION }}

  macos_pkg:
    needs: goreleaser
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Install Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.x'

      - name: Install Syft (for SBOM generation)
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh \
            | sh -s -- -b /usr/local/bin
          syft version

      # --- DEBUG + PREPARE CERTS/KEYCHAIN ---
      - name: Prepare Apple certificate and keychain (with debug)
        env:
          MACOS_CERT_P12: ${{ secrets.MACOS_CERT_P12 }}           # base64 of .p12
          MACOS_CERT_PASSWORD: ${{ secrets.MACOS_CERT_PASSWORD }} # export password of .p12
          MACOS_NOTARY_KEY: ${{ secrets.MACOS_NOTARY_KEY }}       # full PEM with BEGIN/END
        run: |
          set -euo pipefail

          # Write the p12 to a temp file
          CERT_PATH="$RUNNER_TEMP/apple-cert.p12"
          echo "$MACOS_CERT_P12" | base64 -D > "$CERT_PATH"

          # --- Sanity check: verify the file was actually written ---
          if [ -f "$CERT_PATH" ]; then
            echo "âœ… p12 exists at: $CERT_PATH"
            stat -f "ðŸ“¦ p12 size (bytes): %z" "$CERT_PATH"
          else
            echo "âŒ ERROR: p12 file missing at $CERT_PATH"
            exit 1
          fi

          # Verify the p12 + password (no output means success)
          echo "ðŸ” Verifying .p12 integrity..."
          /usr/bin/openssl pkcs12 -in "$CERT_PATH" -noout -passin pass:"$MACOS_CERT_PASSWORD"
          echo "âœ… .p12 password verified successfully"

          # Quick check the notary key looks like a PEM (headers only)
          echo "ðŸ”‘ Checking Notary API key format:"
          echo "$MACOS_NOTARY_KEY" | head -n 1
          echo "$MACOS_NOTARY_KEY" | tail -n 1

          # Create and configure a dedicated build keychain
          echo "ðŸ” Creating and unlocking temporary build keychain..."
          security create-keychain -p "" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          security unlock-keychain -p "" build.keychain

          # Import p12 into the build keychain
          echo "ðŸ“¥ Importing .p12 into keychain..."
          security import "$CERT_PATH" -k ~/Library/Keychains/build.keychain \
            -P "$MACOS_CERT_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security

          # Make the build keychain default and verify itâ€™s active
          security list-keychains -d user -s ~/Library/Keychains/build.keychain
          security default-keychain -s ~/Library/Keychains/build.keychain

          # Show available signing identities (for debugging)
          echo "ðŸ”Ž Listing available signing identities..."
          security find-identity -p codesigning -v || true

          # Export the cert path for GoReleaser (so we can reference a FILE, not base64)
          echo "MACOS_SIGN_P12_PATH=$CERT_PATH" >> "$GITHUB_ENV"
          echo "âœ… Exported MACOS_SIGN_P12_PATH for GoReleaser"

      - name: Prepare Notary API key file (Part A)
        env:
          MACOS_NOTARY_KEY: ${{ secrets.MACOS_NOTARY_KEY }}
        run: |
          set -euo pipefail
          KEY_PATH="$RUNNER_TEMP/notary-api-key.p8"
          # Preserve newlines exactly:
          printf "%s" "$MACOS_NOTARY_KEY" > "$KEY_PATH"
          # Quick sanity check of headers
          head -n1 "$KEY_PATH" || true
          tail -n1 "$KEY_PATH" || true
          echo "MACOS_NOTARY_KEY_PATH=$KEY_PATH" >> "$GITHUB_ENV"

      # --- RUN GORELEASER WITH FULL ENV ---
      - name: Run GoReleaser (build + sign + notarize + upload)
        uses: goreleaser/goreleaser-action@v6.4.0
        with:
          distribution: goreleaser-pro
          version: latest
          args: release --clean --config .goreleaser.yaml --debug
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GORELEASER_KEY: ${{ secrets.GORELEASER_KEY }}
          GH_PAT: ${{ secrets.GH_PAT }}
          TNR_S3_BUCKET: ${{ secrets.TNR_S3_BUCKET }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          DEVELOPER_ID_APP: ${{ secrets.DEVELOPER_ID_APP }}
          MACOS_SIGN_P12_PATH: ${{ env.MACOS_SIGN_P12_PATH }}
          MACOS_CERT_P12: ${{ secrets.MACOS_CERT_P12 }}
          MACOS_CERT_PASSWORD: ${{ secrets.MACOS_CERT_PASSWORD }}
          # MACOS_NOTARY_KEY: {{ secrets.MACOS_NOTARY_KEY }}
          MACOS_NOTARY_KEY_PATH: ${{ env.MACOS_NOTARY_KEY_PATH }}
          MACOS_NOTARY_KEY_ID: ${{ secrets.MACOS_NOTARY_KEY_ID }}
          MACOS_NOTARY_ISSUER_ID: ${{ secrets.MACOS_NOTARY_ISSUER_ID }}


  # goreleaser_windows:
  #   needs: goreleaser
  #   runs-on: windows-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: aws-actions/configure-aws-credentials@v4
  #       with:
  #         role-to-assume: {{ secrets.AWS_ROLE_ARN }}
  #         aws-region: {{ secrets.AWS_REGION }}
  #     - name: Install WiX
  #       shell: pwsh
  #       run: |
  #         winget install --id WixToolset.WixToolset --silent --accept-package-agreements --accept-source-agreements
  #         $env:PATH += ";$Env:LOCALAPPDATA\Microsoft\WinGet\Packages\WixToolset.WixToolset_Microsoft.Winget.Source_8wekyb3d8bbwe\wix"
  #         echo $env:PATH
  #         wix --version
  #         # If using extensions, install them too (names per WiX v4):
  #         # wix extension add -g WixToolset.UI.wixext
  #         # wix extension add -g WixToolset.Util.wixext
  #     - name: GoReleaser (build + publish)
  #       uses: goreleaser/goreleaser-action@v6.4.0
  #       with:
  #         distribution: goreleaser-pro
  #         version: latest
  #         args: release --clean --config .goreleaser.yaml
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #         GORELEASER_KEY: ${{ secrets.GORELEASER_KEY }}
  #         GH_PAT: ${{ secrets.GH_PAT }}
  #         TNR_S3_BUCKET: ${{ secrets.TNR_S3_BUCKET }}
  #         AWS_REGION: ${{ secrets.AWS_REGION }}