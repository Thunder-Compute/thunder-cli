name: release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  id-token: write

jobs:
  #KEEP
  # ubuntu_release:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0

  #     - name: Setup Go
  #       uses: actions/setup-go@v5
  #       with:
  #         go-version: '1.25.x'

  #     - name: Run tests
  #       run: go test ./... -v

  #     - name: Configure AWS credentials (OIDC)
  #       uses: aws-actions/configure-aws-credentials@v4
  #       with:
  #         role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
  #         aws-region: ${{ secrets.AWS_REGION }}

  #     - name: Install Syft (for SBOM)
  #       run: |
  #         curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
  #         syft version

  #     - name: "GoReleaser (Ubuntu: linux publish)"
  #       uses: goreleaser/goreleaser-action@v6.4.0
  #       with:
  #         distribution: goreleaser-pro
  #         version: latest
  #         args: release --clean --config .goreleaser.ubuntu.yaml --skip=announce --skip=notarize --skip=sign
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #         GORELEASER_KEY: ${{ secrets.GORELEASER_KEY }}
  #         GH_PAT: ${{ secrets.GH_PAT }}
  #         TNR_S3_BUCKET: ${{ secrets.TNR_S3_BUCKET }}
  #         AWS_REGION: ${{ secrets.AWS_REGION }}

  # windows_release:
  #   runs-on: windows-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #       with: { fetch-depth: 0 }

  #     - uses: actions/setup-go@v5
  #       with: { go-version: '1.25.x' }

  #     - name: Configure AWS credentials (OIDC)
  #       uses: aws-actions/configure-aws-credentials@v4
  #       with:
  #         role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
  #         aws-region: ${{ secrets.AWS_REGION }}

  #     - name: Install WiX v4
  #       shell: pwsh
  #       run: |
  #         # Install WiX v4 as a .NET tool (the proper way for WiX v4)
  #         dotnet tool install --global wix --version 4.*
          
  #         # Add .NET tools to PATH
  #         $dotnetToolsPath = "$env:USERPROFILE\.dotnet\tools"
  #         $env:PATH = "$dotnetToolsPath;$env:PATH"
  #         echo "$dotnetToolsPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          
  #         # Verify installation
  #         wix --version

  #     - name: Install Syft (for SBOM)
  #       shell: pwsh
  #       run: |
  #         # Download and install Syft for Windows
  #         $syftVersion = "v1.18.0"
  #         $syftUrl = "https://github.com/anchore/syft/releases/download/$syftVersion/syft_1.18.0_windows_amd64.zip"
  #         $syftZip = "$env:TEMP\syft.zip"
  #         $syftDir = "$env:TEMP\syft"
          
  #         Invoke-WebRequest -Uri $syftUrl -OutFile $syftZip
  #         Expand-Archive -Path $syftZip -DestinationPath $syftDir -Force
          
  #         # Add to PATH
  #         $env:PATH = "$syftDir;$env:PATH"
  #         echo "$syftDir" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          
  #         # Verify installation
  #         syft version

  #     - name: "GoReleaser (Windows: build MSI + publish)"
  #       uses: goreleaser/goreleaser-action@v6.4.0
  #       with:
  #         distribution: goreleaser-pro
  #         version: latest
  #         args: release --clean --config .goreleaser.windows.yaml --skip=announce
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #         GORELEASER_KEY: ${{ secrets.GORELEASER_KEY }}
  #         GH_PAT: ${{ secrets.GH_PAT }}
  #         TNR_S3_BUCKET: ${{ secrets.TNR_S3_BUCKET }}
  #         AWS_REGION: ${{ secrets.AWS_REGION }}

  macos_release:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Setup Go
        uses: actions/setup-go@v5
        with: { go-version: '1.25.x' }

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Install Syft (for SBOM)
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
          syft version

      - name: Prepare Apple certificate and keychain
        env:
          MACOS_CERT_P12: ${{ secrets.MACOS_CERT_P12 }}
          MACOS_CERT_PASSWORD: ${{ secrets.MACOS_CERT_PASSWORD }}
        run: |
          set -euo pipefail
          CERT_PATH="$RUNNER_TEMP/apple-cert.p12"
          echo "$MACOS_CERT_P12" | base64 -D > "$CERT_PATH"
          /usr/bin/openssl pkcs12 -in "$CERT_PATH" -noout -passin pass:"$MACOS_CERT_PASSWORD"
          security create-keychain -p "" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          security unlock-keychain -p "" build.keychain
          security import "$CERT_PATH" -k ~/Library/Keychains/build.keychain \
            -P "$MACOS_CERT_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security -T /usr/bin/productsign
          security list-keychains -d user -s ~/Library/Keychains/build.keychain
          security default-keychain -s ~/Library/Keychains/build.keychain
          security find-identity -p codesigning -v || true
          echo "MACOS_SIGN_P12_PATH=$CERT_PATH" >> "$GITHUB_ENV"

      - name: "GoReleaser (macOS: build + sign + notarize + publish)"
        uses: goreleaser/goreleaser-action@v6.4.0
        with:
          distribution: goreleaser-pro
          version: latest
          args: release --clean --config .goreleaser.macos.yaml --skip=announce
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GORELEASER_KEY: ${{ secrets.GORELEASER_KEY }}
          GH_PAT: ${{ secrets.GH_PAT }}
          TNR_S3_BUCKET: ${{ secrets.TNR_S3_BUCKET }}
          AWS_REGION: ${{ secrets.AWS_REGION }}

          # Binary signing
          DEVELOPER_ID_APP: ${{ secrets.DEVELOPER_ID_APP }}
          MACOS_SIGN_P12: ${{ secrets.MACOS_SIGN_P12}}
          MACOS_CERT_PASSWORD: ${{ secrets.MACOS_CERT_PASSWORD }}

          # PKG signing
          DEVELOPER_ID_INSTALLER: ${{ secrets.DEVELOPER_ID_INSTALLER }}
          MACOS_NOTARY_KEY: ${{ secrets.MACOS_NOTARY_KEY }}
          MACOS_NOTARY_KEY_ID: ${{ secrets.MACOS_NOTARY_KEY_ID }}
          MACOS_NOTARY_ISSUER_ID: ${{ secrets.MACOS_NOTARY_ISSUER_ID }}


        
        


# name: release

# on:
#   push:
#     tags:
#       - 'v*'

# permissions:
#   contents: write
#   id-token: write

# jobs:
#   goreleaser:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4
#         with:
#           fetch-depth: 0

#       - name: Setup Go
#         uses: actions/setup-go@v5
#         with:
#           go-version: '1.25.x'

#       - name: Run tests
#         run: go test ./... -v

#       - name: Configure AWS credentials (OIDC)
#         uses: aws-actions/configure-aws-credentials@v4
#         with:
#           role-to-assume: {{ secrets.AWS_ROLE_ARN }}
#           aws-region: {{ secrets.AWS_REGION }}

#       - name: Install Syft (for SBOM generation)
#         run: |
#           curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh \
#             | sh -s -- -b /usr/local/bin
#           syft version

#       - name: GoReleaser
#         uses: goreleaser/goreleaser-action@v6.4.0
#         with:
#           distribution: goreleaser-pro
#           version: latest
#           args: release --clean --config .goreleaser.yaml --skip=sign --skip=notarize
#         env:
#           GITHUB_TOKEN: {{ secrets.GITHUB_TOKEN }}
#           GORELEASER_KEY: {{ secrets.GORELEASER_KEY }}
#           GH_PAT: {{ secrets.GH_PAT }}
#           TNR_S3_BUCKET: {{ secrets.TNR_S3_BUCKET }}
#           AWS_REGION: {{ secrets.AWS_REGION }}

#   # goreleaser_windows:
#   #   needs: goreleaser
#   #   runs-on: windows-latest
#   #   steps:
#   #     - uses: actions/checkout@v4
#   #     - uses: aws-actions/configure-aws-credentials@v4
#   #       with:
#   #         role-to-assume: {{ secrets.AWS_ROLE_ARN }}
#   #         aws-region: {{ secrets.AWS_REGION }}
#   #     - name: Install WiX
#   #       shell: pwsh
#   #       run: |
#   #         winget install --id WixToolset.WixToolset --silent --accept-package-agreements --accept-source-agreements
#   #         $env:PATH += ";$Env:LOCALAPPDATA\Microsoft\WinGet\Packages\WixToolset.WixToolset_Microsoft.Winget.Source_8wekyb3d8bbwe\wix"
#   #         echo $env:PATH
#   #         wix --version
#   #         # If using extensions, install them too (names per WiX v4):
#   #         # wix extension add -g WixToolset.UI.wixext
#   #         # wix extension add -g WixToolset.Util.wixext
#   #     - name: GoReleaser (build + publish)
#   #       uses: goreleaser/goreleaser-action@v6.4.0
#   #       with:
#   #         distribution: goreleaser-pro
#   #         version: latest
#   #         args: release --clean --config .goreleaser.yaml
#   #       env:
#   #         GITHUB_TOKEN: {{ secrets.GITHUB_TOKEN }}
#   #         GORELEASER_KEY: {{ secrets.GORELEASER_KEY }}
#   #         GH_PAT: {{ secrets.GH_PAT }}
#   #         TNR_S3_BUCKET: {{ secrets.TNR_S3_BUCKET }}
#   #         AWS_REGION: {{ secrets.AWS_REGION }}