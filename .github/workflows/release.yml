name: release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  id-token: write

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.x'

      - name: Run tests
        run: go test ./... -v

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Install Syft (for SBOM generation)
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh \
            | sh -s -- -b /usr/local/bin
          syft version

      - name: GoReleaser
        uses: goreleaser/goreleaser-action@v6.4.0
        with:
          distribution: goreleaser-pro
          version: latest
          args: release --clean --config .goreleaser.yaml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GORELEASER_KEY: ${{ secrets.GORELEASER_KEY }}
          GH_PAT: ${{ secrets.GH_PAT }}
          TNR_S3_BUCKET: ${{ secrets.TNR_S3_BUCKET }}
          AWS_REGION: ${{ secrets.AWS_REGION }}


  macos_pkg:
    needs: goreleaser
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Install Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.x'

      - name: Import Apple certificate
        env:
          MACOS_CERT_P12: ${{ secrets.MACOS_CERT_P12 }}
          MACOS_CERT_PASSWORD: ${{ secrets.MACOS_CERT_PASSWORD }}
        run: |
          echo "$MACOS_CERT_P12" | base64 --decode > certificate.p12
          security create-keychain -p "" build.keychain
          security import certificate.p12 -k ~/Library/Keychains/build.keychain -P "$MACOS_CERT_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "" ~/Library/Keychains/build.keychain
          security default-keychain -s ~/Library/Keychains/build.keychain

      - name: Run GoReleaser (build + sign + notarize + upload)
        uses: goreleaser/goreleaser-action@v6.4.0
        with:
          distribution: goreleaser-pro
          version: latest
          args: release --clean --config .goreleaser.yaml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GORELEASER_KEY: ${{ secrets.GORELEASER_KEY }}
          GH_PAT: ${{ secrets.GH_PAT }}
          TNR_S3_BUCKET: ${{ secrets.TNR_S3_BUCKET }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_PWD: ${{ secrets.APPLE_APP_PWD }}
          DEVELOPER_ID_APP: ${{ secrets.DEVELOPER_ID_APP }}

  goreleaser_windows:
    needs: goreleaser
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
      - name: Install WiX
        shell: pwsh
        run: |
          winget install --id WixToolset.WixToolset --silent --accept-package-agreements --accept-source-agreements
          $env:PATH += ";$Env:LOCALAPPDATA\Microsoft\WinGet\Packages\WixToolset.WixToolset_Microsoft.Winget.Source_8wekyb3d8bbwe\wix"
          echo $env:PATH
          wix --version
          # If using extensions, install them too (names per WiX v4):
          # wix extension add -g WixToolset.UI.wixext
          # wix extension add -g WixToolset.Util.wixext
      - name: GoReleaser (build + publish)
        uses: goreleaser/goreleaser-action@v6.4.0
        with:
          distribution: goreleaser-pro
          version: latest
          args: release --clean --config .goreleaser.yaml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GORELEASER_KEY: ${{ secrets.GORELEASER_KEY }}
          GH_PAT: ${{ secrets.GH_PAT }}
          TNR_S3_BUCKET: ${{ secrets.TNR_S3_BUCKET }}
          AWS_REGION: ${{ secrets.AWS_REGION }}

