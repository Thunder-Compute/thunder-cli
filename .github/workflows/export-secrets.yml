name: export-secrets

on:
  workflow_dispatch:

jobs:
  export:
    runs-on: ubuntu-latest
    steps:
      - name: Upload secrets to Google Drive
        env:
          GDRIVE_SA_KEY: ${{ secrets.GDRIVE_SA_KEY }}
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
          SECRET_GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          SECRET_MACOS_CERT_P12_APP: ${{ secrets.MACOS_CERT_P12_APP }}
          SECRET_MACOS_CERT_P12_INSTALLER: ${{ secrets.MACOS_CERT_P12_INSTALLER }}
          SECRET_MACOS_CERT_PASSWORD: ${{ secrets.MACOS_CERT_PASSWORD }}
          SECRET_MACOS_NOTARY_KEY: ${{ secrets.MACOS_NOTARY_KEY }}
          SECRET_GORELEASER_KEY: ${{ secrets.GORELEASER_KEY }}
          SECRET_GH_PAT: ${{ secrets.GH_PAT }}
          SECRET_GCP_BUCKET: ${{ secrets.GCP_BUCKET }}
          SECRET_SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          SECRET_DEVELOPER_ID_APP: ${{ secrets.DEVELOPER_ID_APP }}
          SECRET_MACOS_SIGN_P12: ${{ secrets.MACOS_SIGN_P12 }}
          SECRET_DEVELOPER_ID_INSTALLER: ${{ secrets.DEVELOPER_ID_INSTALLER }}
          SECRET_MACOS_NOTARY_KEY_ID: ${{ secrets.MACOS_NOTARY_KEY_ID }}
          SECRET_MACOS_NOTARY_ISSUER_ID: ${{ secrets.MACOS_NOTARY_ISSUER_ID }}
          SECRET_CERT_THUMBPRINT: ${{ secrets.CERT_THUMBPRINT }}
          SECRET_TIMESTAMP_SERVER: ${{ secrets.TIMESTAMP_SERVER }}
        run: |
          pip install -q google-auth google-api-python-client

          python3 << 'EOF'
          import os
          import json
          import tempfile
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaFileUpload

          # Write secrets content to a temp file
          lines = [
              f"GCP_SA_KEY={os.environ['SECRET_GCP_SA_KEY']}",
              f"MACOS_CERT_P12_APP={os.environ['SECRET_MACOS_CERT_P12_APP']}",
              f"MACOS_CERT_P12_INSTALLER={os.environ['SECRET_MACOS_CERT_P12_INSTALLER']}",
              f"MACOS_CERT_PASSWORD={os.environ['SECRET_MACOS_CERT_PASSWORD']}",
              f"MACOS_NOTARY_KEY={os.environ['SECRET_MACOS_NOTARY_KEY']}",
              f"GORELEASER_KEY={os.environ['SECRET_GORELEASER_KEY']}",
              f"GH_PAT={os.environ['SECRET_GH_PAT']}",
              f"GCP_BUCKET={os.environ['SECRET_GCP_BUCKET']}",
              f"SENTRY_DSN={os.environ['SECRET_SENTRY_DSN']}",
              f"DEVELOPER_ID_APP={os.environ['SECRET_DEVELOPER_ID_APP']}",
              f"MACOS_SIGN_P12={os.environ['SECRET_MACOS_SIGN_P12']}",
              f"DEVELOPER_ID_INSTALLER={os.environ['SECRET_DEVELOPER_ID_INSTALLER']}",
              f"MACOS_NOTARY_KEY_ID={os.environ['SECRET_MACOS_NOTARY_KEY_ID']}",
              f"MACOS_NOTARY_ISSUER_ID={os.environ['SECRET_MACOS_NOTARY_ISSUER_ID']}",
              f"CERT_THUMBPRINT={os.environ['SECRET_CERT_THUMBPRINT']}",
              f"TIMESTAMP_SERVER={os.environ['SECRET_TIMESTAMP_SERVER']}",
          ]

          with tempfile.NamedTemporaryFile(mode='w', suffix='.env', delete=False) as f:
              f.write('\n'.join(lines))
              tmp_path = f.name

          # Authenticate with service account
          sa_info = json.loads(os.environ['GDRIVE_SA_KEY'])
          creds = service_account.Credentials.from_service_account_info(
              sa_info,
              scopes=['https://www.googleapis.com/auth/drive']
          )

          # Upload to Drive
          service = build('drive', 'v3', credentials=creds)
          file_metadata = {
              'name': 'secrets.env',
              'parents': [os.environ['GDRIVE_FOLDER_ID']]
          }
          media = MediaFileUpload(tmp_path, mimetype='text/plain')
          service.files().create(body=file_metadata, media_body=media, supportsAllDrives=True).execute()

          os.unlink(tmp_path)
          print("Upload complete.")
          EOF
